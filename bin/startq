#!/bin/bash

q_dir=$(dirname $0)/../q

log_dir=${q_dir}/logs
mkdir -p $log_dir
log_str=$(hostname).$(date +%y%m%dd%h%m%s)

while [ "$1" != "" ]; do
    case $1 in
        -p | --app )
                shift
                app=$1
                ;;
        -l | --log-dir )
                shift
                log_dir=$1
                ;;
    esac
    shift
done

if [[ "$app" == "" ]]; then
    echo "Error: -a, --app argument is needed"
    exit 1
fi

tplog_dir=/opt/rdb-autoscaling/tplogs
mkdir -p $tplog_dir

cd $q_dir

case "$app" in
    tick-asg )
        nohup q tickasg.q sym $tplog_dir -p 5010 > ${log_dir}/tickasg.${log_str} 2>&1 &
        nohup q tick/r.q    :5010 -p 5011 > ${log_dir}/r.${log_str}    2>&1 &
        nohup q asg/mon.q   :5010 -p 5012 > ${log_dir}/mon.${log_str}  2>&1 &
        nohup q asg/feed.q  :5010 -p 5013 > ${log_dir}/feed.${log_str} 2>&1 &
        nohup q asg/ls.q    :5010 -p 5014 > ${log_dir}/ls.${log_str}   2>&1 &
        ;;
    r-asg )
        nohup q asg/r.q   $TPHOST:5010 $TPHOST:5014 -p 5011 > ${log_dir}/rasg.${log_str} 2>&1 & 2>&1 &
        nohup q asg/mon.q $TPHOST:5010 -p 5011 > ${log_dir}/mon.${log_str} 2>&1 &
        ;;
esac

echo $log_file

echo "started $app app"
